!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function t(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach((function(e){i(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&u(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return f(e)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=s(e);if(t){var o=s(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return c(this,n)}}var p,v="object"==typeof Reflect?Reflect:null,d=v&&"function"==typeof v.apply?v.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};p=v&&"function"==typeof v.ownKeys?v.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var h=Number.isNaN||function(e){return e!=e};function m(){m.init.call(this)}var y=m,g=function(e,t){return new Promise((function(n,r){function o(n){e.removeListener(t,i),r(n)}function i(){"function"==typeof e.removeListener&&e.removeListener("error",o),n([].slice.call(arguments))}P(e,t,i,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&P(e,"error",t,n)}(e,o,{once:!0})}))};m.EventEmitter=m,m.prototype._events=void 0,m.prototype._eventsCount=0,m.prototype._maxListeners=void 0;var w=10;function b(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function _(e){return void 0===e._maxListeners?m.defaultMaxListeners:e._maxListeners}function L(e,t,n,r){var o,i,a,s;if(b(n),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),a=i[t]),void 0===a)a=i[t]=n,++e._eventsCount;else if("function"==typeof a?a=i[t]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),(o=_(e))>0&&a.length>o&&!a.warned){a.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=a.length,s=u,console&&console.warn&&console.warn(s)}return e}function O(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function x(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},o=O.bind(r);return o.listener=n,r.wrapFn=o,o}function j(e,t,n){var r=e._events;if(void 0===r)return[];var o=r[t];return void 0===o?[]:"function"==typeof o?n?[o.listener||o]:[o]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(o):k(o,o.length)}function C(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function k(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function P(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function o(i){r.once&&e.removeEventListener(t,o),n(i)}))}}function E(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function A(e,t){return e(t={exports:{}},t.exports),t.exports}Object.defineProperty(m,"defaultMaxListeners",{enumerable:!0,get:function(){return w},set:function(e){if("number"!=typeof e||e<0||h(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");w=e}}),m.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},m.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||h(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},m.prototype.getMaxListeners=function(){return _(this)},m.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var s=o[e];if(void 0===s)return!1;if("function"==typeof s)d(s,this,t);else{var u=s.length,f=k(s,u);for(n=0;n<u;++n)d(f[n],this,t)}return!0},m.prototype.addListener=function(e,t){return L(this,e,t,!1)},m.prototype.on=m.prototype.addListener,m.prototype.prependListener=function(e,t){return L(this,e,t,!0)},m.prototype.once=function(e,t){return b(t),this.on(e,x(this,e,t)),this},m.prototype.prependOnceListener=function(e,t){return b(t),this.prependListener(e,x(this,e,t)),this},m.prototype.removeListener=function(e,t){var n,r,o,i,a;if(b(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(o=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){a=n[i].listener,o=i;break}if(o<0)return this;0===o?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,o),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,a||t)}return this},m.prototype.off=m.prototype.removeListener,m.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var o,i=Object.keys(n);for(r=0;r<i.length;++r)"removeListener"!==(o=i[r])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},m.prototype.listeners=function(e){return j(this,e,!0)},m.prototype.rawListeners=function(e){return j(this,e,!1)},m.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):C.call(e,t)},m.prototype.listenerCount=C,m.prototype.eventNames=function(){return this._eventsCount>0?p(this._events):[]},y.once=g;var B=A((function(e,t){t.__esModule=!0,t.default=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}}));E(B);var M=A((function(e){var t=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=t)})),R=A((function(e){var t=e.exports={version:"2.6.12"};"number"==typeof __e&&(__e=t)})),D=(R.version,function(e,t,n){if(function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!")}(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,o){return e.call(t,n,r,o)}}return function(){return e.apply(t,arguments)}}),S=function(e){return"object"==typeof e?null!==e:"function"==typeof e},T=function(e){if(!S(e))throw TypeError(e+" is not an object!");return e},F=function(e){try{return!!e()}catch(e){return!0}},V=!F((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})),U=M.document,W=S(U)&&S(U.createElement),I=!V&&!F((function(){return 7!=Object.defineProperty((e="div",W?U.createElement(e):{}),"a",{get:function(){return 7}}).a;var e})),N=Object.defineProperty,q={f:V?Object.defineProperty:function(e,t,n){if(T(e),t=function(e,t){if(!S(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!S(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!S(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!S(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")}(t,!0),T(n),I)try{return N(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},G=V?function(e,t,n){return q.f(e,t,function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}(1,n))}:function(e,t,n){return e[t]=n,e},K={}.hasOwnProperty,z=function(e,t){return K.call(e,t)},H=function(e,t,n){var r,o,i,a=e&H.F,s=e&H.G,u=e&H.S,f=e&H.P,c=e&H.B,l=e&H.W,p=s?R:R[t]||(R[t]={}),v=p.prototype,d=s?M:u?M[t]:(M[t]||{}).prototype;for(r in s&&(n=t),n)(o=!a&&d&&void 0!==d[r])&&z(p,r)||(i=o?d[r]:n[r],p[r]=s&&"function"!=typeof d[r]?n[r]:c&&o?D(i,M):l&&d[r]==i?function(e){var t=function(t,n,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n)}return new e(t,n,r)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(i):f&&"function"==typeof i?D(Function.call,i):i,f&&((p.virtual||(p.virtual={}))[r]=i,e&H.R&&v&&!v[r]&&G(v,r,i)))};H.F=1,H.G=2,H.S=4,H.P=8,H.B=16,H.W=32,H.U=64,H.R=128;var J=H;J(J.S+J.F*!V,"Object",{defineProperty:q.f});var Q=R.Object,X=function(e,t,n){return Q.defineProperty(e,t,n)},Y=A((function(e){e.exports={default:X,__esModule:!0}}));E(Y);var Z=A((function(e,t){t.__esModule=!0;var n,r=(n=Y)&&n.__esModule?n:{default:n};t.default=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),(0,r.default)(e,o.key,o)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}()}));E(Z);var $=A((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=o(B),r=o(Z);function o(e){return e&&e.__esModule?e:{default:e}}t.start=l,t.stop=function(){a=!1,cancelAnimationFrame(f)},t.setTimeout=function(e,t){return l(),new c({gap:t,loop:1},e)},t.setInterval=function(e,t){return l(),new c({gap:t},e)},t.clock=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return l(),new c({gap:t,loop:n},e)},t.clearClock=p,t.clearTimeout=function(e){p(e)},t.clearInterval=function(e){p(e)};var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},a=!1,s=[],u=0,f=void 0,c=function(){function e(t,r){(0,n.default)(this,e);var o=t.gap,i=void 0===o?1:o,a=t.loop,u=void 0===a?1/0:a,f=t.destory,c=void 0!==f&&f;this.gap=i,this.loop=u,this.isDestory=c,this.start=Date.now(),this.cb=r||function(){},s.push(this)}return(0,r.default)(e,[{key:"destory",value:function(){this.isDestory=!0}},{key:"run",value:function(){if(0===this.loop||this.isDestory)this.destory();else if(u-this.start>=this.gap){var e=u-this.start;this.loop--,this.start=u,this.cb(u,e)}}}]),e}();function l(){a||(a=!0,function e(){u=Date.now();for(var t=0;t<s.length;t++){var n=s[t];n.run(),n.isDestory&&(s.splice(t,1),t--)}f=i(e)}())}function p(e){e&&e.destory()}})),ee=E($),te=($.start,$.stop,$.setTimeout,$.setInterval,$.clock,$.clearClock,$.clearTimeout,$.clearInterval,"\nvar recLength = 0,\n  recBuffersL = [],\n  sampleRate;\nvar bdSampleRate = 16000;\n\nthis.onmessage = function(e){\n  switch(e.data.command){\n    case 'init':\n      init(e.data.config);\n      break;\n    case 'record':\n      record(e.data.buffer);\n      break;\n    case 'exportWAV':\n      exportWAV(e.data.type);\n      break;\n    case 'getBuffer':\n      getBuffer();\n      break;\n    case 'clear':\n      clear();\n      break;\n  }\n};\n\nfunction init(config){\n  sampleRate = config.sampleRate;\n}\n\nfunction record(inputBuffer){\n  recBuffersL.push(inputBuffer[0]);\n  recLength += inputBuffer[0].length;\n}\n\nfunction exportWAV(type){\n  if (recLength === 0) {\n    this.postMessage(new Blob([], { type: type }));\n    return;\n  };\n  var bufferL = mergeBuffers(recBuffersL, recLength);\n  var interleaved = interleave(bufferL);\n  var dataview = encodeWAV(interleaved);\n  var audioBlob = new Blob([dataview], { type: type });\n\n  this.postMessage(audioBlob);\n  // export后自动clear\n  clear();\n}\n\nfunction getBuffer() {\n  var buffers = [];\n  buffers.push( mergeBuffers(recBuffersL, recLength) );\n  this.postMessage(buffers);\n}\n\nfunction clear(){\n  recLength = 0;\n  recBuffersL = [];\n}\n\nfunction mergeBuffers(recBuffers, recLength){\n  var result = new Float32Array(recLength);\n  var offset = 0;\n  for (var i = 0; i < recBuffers.length; i++){\n    result.set(recBuffers[i], offset);\n    offset += recBuffers[i].length;\n  }\n  return result;\n}\n\nfunction interleave(inputL){\n  var compression = sampleRate / bdSampleRate;\n  var length = inputL.length / compression;\n  var result = new Float32Array(length);\n\n  var index = 0,\n      inputIndex = 0;\n\n  while (index < length){\n    result[index++] = inputL[parseInt(inputIndex)];\n    inputIndex += compression;\n  }\n  return result;\n}\n\nfunction floatTo16BitPCM(output, offset, input){\n  for (var i = 0; i < input.length; i++, offset+=2){\n    var s = Math.max(-1, Math.min(1, input[i]));\n    output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);\n  }\n}\nfunction floatTo8BitPCM(output, offset, input) {\n  //这里只能加1了\n  for (var i = 0; i < input.length; i++, offset++) {\n    var s = Math.max(-1, Math.min(1, input[i]));\n    var val = s < 0 ? s * 0x8000 : s * 0x7FFF;\n    //这里有一个转换的代码,这个是我个人猜测的,就是按比例转换\n    val = parseInt(255 / (65535 / (val + 32768)));\n    output.setInt8(offset, val, true);\n  }\n}\n\nfunction writeString(view, offset, string){\n  for (var i = 0; i < string.length; i++){\n    view.setUint8(offset + i, string.charCodeAt(i));\n  }\n}\n\nfunction encodeWAV(samples) {\n  var sampleBits = 16;//16;//这里改成8位\n  var dataLength = samples.length * (sampleBits / 8);\n  var buffer = new ArrayBuffer(44 + dataLength);\n  var view = new DataView(buffer);\n\n  var sampleRateTmp = bdSampleRate;\n\n  var channelCount = 1;\n  var offset = 0;\n  /* 资源交换文件标识符 */\n  writeString(view, offset, 'RIFF'); offset += 4;\n  /* 下个地址开始到文件尾总字节数,即文件大小-8 */\n  view.setUint32(offset, /*32这里地方栗子中的值错了,但是不知道为什么依然可以运行成功*/ 36 + dataLength, true); offset += 4;\n  /* WAV文件标志 */\n  writeString(view, offset, 'WAVE'); offset += 4;\n  /* 波形格式标志 */\n  writeString(view, offset, 'fmt '); offset += 4;\n  /* 过滤字节,一般为 0x10 = 16 */\n  view.setUint32(offset, 16, true); offset += 4;\n  /* 格式类别 (PCM形式采样数据) */\n  view.setUint16(offset, 1, true); offset += 2;\n  /* 通道数 */\n  view.setUint16(offset, channelCount, true); offset += 2;\n  /* 采样率,每秒样本数,表示每个通道的播放速度 */\n  view.setUint32(offset, sampleRateTmp, true); offset += 4;\n  /* 波形数据传输率 (每秒平均字节数) 通道数×每秒数据位数×每样本数据位/8 */\n  view.setUint32(offset, sampleRateTmp * channelCount * (sampleBits / 8), true); offset += 4;\n  /* 快数据调整数 采样一次占用字节数 通道数×每样本的数据位数/8 */\n  view.setUint16(offset, channelCount * (sampleBits / 8), true); offset += 2;\n  /* 每样本数据位数 */\n  view.setUint16(offset, sampleBits, true); offset += 2;\n  /* 数据标识符 */\n  writeString(view, offset, 'data'); offset += 4;\n  /* 采样数据总数,即数据总大小-44 */\n  view.setUint32(offset, dataLength, true); offset += 4;\n  /* 采样数据 */\n  floatTo16BitPCM(view, 44, samples);\n  return view;\n}\n"),ne=y.EventEmitter,re=function(e){a(s,e);var r=l(s);function s(e){var o,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,s),i(f(o=r.call(this,{})),"init",(function(){var e;null===(e=o.worker)||void 0===e||e.postMessage({command:"init",config:{sampleRate:o.context.sampleRate,numChannels:1}}),o.node.onaudioprocess=function(e){var t;o.recording&&(null===(t=o.worker)||void 0===t||t.postMessage({command:"record",buffer:[e.inputBuffer.getChannelData(0)]}))},o.worker.onmessage=function(e){var t=e.data;o.currCallback(t)},o.source.connect(o.node),o.node.connect(o.context.destination)})),i(f(o),"configure",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o.config=t({},e)})),i(f(o),"start",(function(){o.recording=!0})),i(f(o),"stop",(function(){!0===o.recording&&(o.recording=!1,o.onStop&&o.onStop())})),i(f(o),"clear",(function(){var e;null===(e=o.worker)||void 0===e||e.postMessage({command:"clear"})})),i(f(o),"getBuffer",(function(e){var t;o.currCallback=e||o.config.callback,null===(t=o.worker)||void 0===t||t.postMessage({command:"getBuffer"})})),i(f(o),"exportWAV",(function(e,t){var n;if(o.currCallback=e||o.config.callback,t=t||o.config.type||"audio/wav",!o.currCallback)throw new Error("Callback not set");null===(n=o.worker)||void 0===n||n.postMessage({command:"exportWAV",type:t})})),i(f(o),"isEmptyData",(function(e){for(var t=Math.floor(e.length/10),n=0,r=0;r<t;r++)n+=Math.abs(e[10*r]);if(o.emptyCheckCount++,n<10){if(o.emptydatacount++,o.emptydatacount>10)return o.stop(),console.log("stoped"),!0}else o.emptydatacount=0;return!1})),i(f(o),"forceDownload",(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"output.wav",n=(window.URL||window.webkitURL).createObjectURL(e),r=window.document.createElement("a");r.href=n,r.download=t;var o=document.createEvent("Event");o.initEvent("click",!0,!0),r.dispatchEvent(o)})),i(f(o),"onProcess",(function(e){o.on("process",e)})),o.config=a,o.bufferLen=o.config.bufferLen||4096,o.source=e,o.context=o.source.context,o.emptydatacount=0,o.emptyCheckCount=0,o.node=(o.context.createScriptProcessor||o.context.createJavaScriptNode).call(o.context,o.bufferLen,1,1);var u=new Blob([te],{type:"text/javascript"});return o.worker=new Worker(window.URL.createObjectURL(u)),o.recording=!1,o.init(),o}return o(s)}(ne),oe=function(e){a(r,e);var t=l(r);function r(){var e;n(this,r);for(var o=arguments.length,a=new Array(o),s=0;s<o;s++)a[s]=arguments[s];return i(f(e=t.call.apply(t,[this].concat(a))),"start",(function(t){e.context=new AudioContext,e.mediaStreamSource=e.context.createMediaStreamSource(t),e.record=new re(e.mediaStreamSource),e.record.start()})),i(f(e),"processData",(function(){return new Promise((function(t,n){e.mediaStreamSource&&e.record.exportWAV((function(e){t(e)}))}))})),i(f(e),"clear",(function(){var t;null===(t=e.record.worker)||void 0===t||t.postMessage({command:"clear"})})),i(f(e),"onData",(function(t){e.on("data",t)})),i(f(e),"terminateWebWorker",(function(){var t;null===(t=e.record.worker)||void 0===t||t.terminate()})),e}return o(r)}(ne),ie=ee.setTimeout,ae=ee.clearTimeout,se=y.EventEmitter,ue={fps:10,width:200},fe={fps:60},ce=function(e){a(s,e);var r=l(s);function s(e){var o;n(this,s),i(f(o=r.call(this,{})),"_init",(function(){o.record=new oe,o.video=document.createElement("video"),o.video.muted=!0,o.video.autoplay=!0,o.stream&&(o.record.start(o.stream),o.video.srcObject=o.stream,o.video.play()),o.canvas=document.createElement("canvas"),o.context2d=o.canvas.getContext("2d");var e=0,n=0;o.clock=ie((function r(i){if(o.stream){var a=[];if(o._transVideoData){var s=o._videoConfig.fps;i-e>1e3/(void 0===s?10:s)&&(e=i,a.push(o.getVideoData()))}if(o._transAudioData){var u=o._audioConfig.fps;i-n>1e3/(void 0===u?60:u)&&(n=i,a.push(o.getAudioData()))}a.length>0?Promise.all(a).then((function(e){var n={};e.filter((function(e){return e.hasData})).forEach((function(e){n=t(t({},n),e)})),o.clock=ie(r),(n.audio||n.video)&&o.emit("data",n)})).catch((function(){o.clock=ie(r)})):o.clock=ie(r)}else o.clock=ie(r)}))})),i(f(o),"_setVideoConfig",(function(e){o._videoConfig="boolean"==typeof e?ue:e||ue})),i(f(o),"_setAudioConfig",(function(e){o._audioConfig="boolean"==typeof e?fe:e||fe})),i(f(o),"setStream",(function(e){o.stream=e,e.getAudioTracks().length>0?o.record.start(o.stream):o._transAudioData&&console.warn("stream中没有audio数据"),e.getVideoTracks().length>0?(o.video.srcObject=o.stream,o.video.play()):o._transVideoData&&console.warn("stream中没有video数据")})),i(f(o),"getAudioData",(function(){return o.record.processData().then((function(e){return{audio:e,hasData:"data:"!==e.data}}))})),i(f(o),"getVideoData",(function(){var e=o._videoConfig.width,t=void 0===e?200:e,n=t/o.video.videoWidth*o.video.videoHeight;return o.context2d&&o.context2d.drawImage(o.video,0,0,t,n),Promise.resolve({video:{data:o.canvas.toDataURL("image/webp"),videoTime:Date.now()},hasData:!0})})),i(f(o),"enableVideo",(function(e){o.video.srcObject=o.stream,o.video.play(),o._setVideoConfig(e),o._transVideoData=!!e})),i(f(o),"enableAudio",(function(e){o.record.clear(),o._transAudioData=e})),i(f(o),"onData",(function(e){o.on("data",e)})),i(f(o),"destory",(function(){o.removeAllListeners(),ae(o.clock),o.record.terminateWebWorker()}));var a=e.video,u=void 0!==a&&a,c=e.audio,l=void 0!==c&&c,p=e.stream;return o._transVideoData=!!u,o._transAudioData=!!l,p&&(o.stream=p),o._setVideoConfig(u),o._setAudioConfig(l),o._init(),o}return o(s)}(se);window.Media=ce}));
//# sourceMappingURL=index.js.map
